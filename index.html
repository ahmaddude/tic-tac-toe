<script src="/socket.io/socket.io.js"></script>
<script>
    document.getElementById("loading").style.display="none";
    document.getElementById("bigCont").style.display="none";
    document.getElementById("userCont").style.display="none";
    document.getElementById("OopNameCont").style.display="none";
    document.getElementById("valueCont").style.display="none";
    document.getElementById("whosTurn").style.display="none";

    const socket=io();
    let name;

    // ðŸŽ¨ Create a nice modal for game over
    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.background = "rgba(0,0,0,0.7)";
    modal.style.display = "flex";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.color = "white";
    modal.style.fontSize = "2rem";
    modal.style.fontFamily = "Arial, sans-serif";
    modal.style.zIndex = "1000";
    modal.style.display = "none";
    document.body.appendChild(modal);

    function showGameOver(msg) {
        modal.innerHTML = `
            <div style="background:#222;padding:30px;border-radius:20px;text-align:center;">
                <p style="font-size:2.5rem;">${msg}</p>
                <button onclick="location.reload()" 
                        style="margin-top:20px;padding:10px 20px;font-size:1.2rem;
                               border:none;border-radius:10px;background:#28a745;color:white;cursor:pointer;">
                    Play Again
                </button>
            </div>
        `;
        modal.style.display = "flex";
    }

    document.getElementById("find").addEventListener("click",function(){
        name=document.getElementById("name").value;
        document.getElementById("user").innerText=name
        if(!name){
            alert('enter a name')
        }
        else{
            socket.emit("find",{name:name})
            document.getElementById("loading").style.display="block"
            document.getElementById("find").disabled=true;
        }
    })

    socket.on("find",(e)=>{
        let allPlayersArr=e.allPlayers
        const foundObj=allPlayersArr.find(obj=>obj.p1.p1name==name||obj.p2.p2name==name)

        document.getElementById("userCont").style.display="block";
        document.getElementById("loading").style.display="none";
        document.getElementById("bigCont").style.display="block";
        document.getElementById("OopNameCont").style.display="block";
        document.getElementById("valueCont").style.display="block";
        document.getElementById("whosTurn").style.display="block";
        document.getElementById("name").style.display="none";
        document.getElementById("find").style.display="none";
        document.getElementById("enterName").style.display="none";

        let oopName;
        let value;

        if(foundObj.p1.p1name==name){
            oopName=foundObj.p2.p2name;
            value=foundObj.p1.p1value;
        } else {
            oopName=foundObj.p1.p1name;
            value=foundObj.p2.p2value;
        }

        document.getElementById("OopName").innerText=oopName
        document.getElementById("value").innerText=value

        // âŒ Donâ€™t update board optimistically
        document.querySelectorAll(".btn").forEach(btn => {
            btn.disabled = true; // wait until server says it's your turn
        });
    })

    // When clicking a button â†’ only send to server (donâ€™t update yet)
    document.querySelectorAll(".btn").forEach(btn=>{
        btn.addEventListener("click",function(){
            let value=document.getElementById("value").innerText
            socket.emit("playing",{value:value,id:btn.id,name:name})
            // temporarily disable everything until server confirms
            document.querySelectorAll(".btn").forEach(b=>b.disabled=true);
        })
    })

    // Server confirms game state
    socket.on("playing",(e)=>{
        const foundObj=(e.allPlayers).find(obj=>obj.p1.p1name==name||obj.p2.p2name==name)
        let p1id=foundObj.p1.p1move
        let p2id=foundObj.p2.p2move

        // update board from server state only
        if(p1id!=""){
            document.getElementById(p1id).innerText="X"
            document.getElementById(p1id).disabled=true
        }
        if(p2id!=""){
            document.getElementById(p2id).innerText="O"
            document.getElementById(p2id).disabled=true
        }

        // Turn handling
        let currentTurn = (foundObj.sum)%2==1 ? "X" : "O";
        let myValue = foundObj.p1.p1name==name ? foundObj.p1.p1value : foundObj.p2.p2value;

        document.getElementById("whosTurn").innerText = currentTurn + "'s Turn";

        document.querySelectorAll(".btn").forEach(btn => {
            if(btn.innerText === "") {
                btn.disabled = (currentTurn !== myValue);
            }
        });

        check(foundObj, name);
    })

    function check(foundObj, myName){
        let b = [];
        for(let i=1;i<=9;i++){
            let cell=document.getElementById("btn"+i).innerText;
            b[i]= cell==="" ? String.fromCharCode(96+i) : cell;
        }

        const winCond = (
            (b[1]==b[2]&&b[2]==b[3])||(b[4]==b[5]&&b[5]==b[6])||(b[7]==b[8]&&b[8]==b[9])||
            (b[1]==b[4]&&b[4]==b[7])||(b[2]==b[5]&&b[5]==b[8])||(b[3]==b[6]&&b[6]==b[9])||
            (b[1]==b[5]&&b[5]==b[9])||(b[3]==b[5]&&b[5]==b[7])
        );

        if(winCond){
            socket.emit("gameOver",{name:myName})

            // Who won?
            let winner = (foundObj.sum % 2 == 0) ? "X" : "O";
            let winnerName = (winner=="X") ? foundObj.p1.p1name : foundObj.p2.p2name;

            showGameOver("ðŸŽ‰ " + winnerName + " Won!");
        }
        else if(foundObj.sum==10){
            socket.emit("gameOver",{name:myName})
            showGameOver("ðŸ¤ It's a Draw!");
        }
    }
</script>
